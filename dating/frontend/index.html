<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Dating</title>

        <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
        <link href="/style/style.css" rel="stylesheet">

        <script src="main.prod.js"></script>
    </head>
    <body>
        <script>
            const storageKey = "session";
            const flags = localStorage.getItem(storageKey);
            const app = Elm.Main.init({flags: flags});

            app.ports.storeLocally.subscribe(function(val) {
                if (val === null) {
                    localStorage.removeItem(storageKey);
                } else {
                    localStorage.setItem(storageKey, JSON.stringify(val));
                }

                // Report that the new session was stored successfully.
                setTimeout(function() {
                    app.ports.onStoreChange.send(localStorage.getItem(storageKey));
                }, 0);
            });

            // Whenever localStorage changes in another tab, report it
            window.addEventListener("storage", function(event) {
                console.log(event);
                if (event.storageArea === localStorage) {
                    console.log('Calling onStoreChange!');
                    app.ports.onStoreChange.send(event.newValue);
                }
            });


            app.ports.fileSelected.subscribe(function () {
                const node = $('input[type="file"]')[0];
                    if (!node) {
                        return;
                    }

                const file = node.files[0];

                // If something other than an image is selected
                if (file.type.split('/')[0] !== 'image') {
                    // Remove it
                    node.value = '';

                    // And send an error to Elm
                    app.ports.fileContentRead.send({
                        error: 'Unsupported file type',
                        contents: '',
                        fileName: ''
                    });

                    return;
                }

                const reader = new FileReader();

                // Connect our FileReader with the file that was selected in our `input` node.
                reader.readAsDataURL(file);

                // FileReader API is event based. Once a file is selected
                // it fires events. We hook into the `onload` event for our reader.
                reader.onload = (function(event) {
                    // The event carries the `target`. The `target` is the file
                    // that was selected. The result is base64 encoded contents of the file.
                    const base64encoded = event.target.result;

                    // We call the `fileContentRead` port with the file data
                    // which will be sent to our Elm runtime via Subscriptions.
                    app.ports.fileContentRead.send({
                        error: '',
                        contents: base64encoded,
                        fileName: file.name
                    });
                });
            });

            const offset = 350;
            let timeout;
            let loading = false;
            let lastHeight = 0;

            function getWindowHeight() {
                const body = document.body;
                const html = document.documentElement;

                return Math.max(body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight);
            }

            // Listen for scroll events
            window.addEventListener("scroll", function(e) {
                clearTimeout(timeout);

                timeout = setTimeout(function() {
                    const triggerHeight = getWindowHeight() - window.innerHeight - offset;

                    if (loading) {
                        if (triggerHeight > lastHeight) {
                            loading = false;
                        } else {
                            return;
                        }
                    }

                    if (window.scrollY >= triggerHeight) {
                        loading = true;
                        app.ports.loadMore.send(true);
                    }

                    lastHeight = triggerHeight;
                }, 100);
            });
        </script>

        <script>
            const navEl = document.querySelector('header nav');

            document.querySelector('header .logo').addEventListener('click', function (e) {
                document.body.classList.remove('disableScroll');
                navEl.classList.add('closed');
            });

            navEl.addEventListener('click', function (e) {
                const targetTag = e.target.tagName;

                if (targetTag === 'NAV' || targetTag === 'A') {
                    document.body.classList.toggle('disableScroll');
                    navEl.classList.toggle('closed');
                }
            });
        </script>
    </body>
</html>
